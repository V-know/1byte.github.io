<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Gavin Wei">



<meta name="description" content="IntroductionCollecting and visualizing data is an important way to make informed decisions about your servers and projects. In a previous guide, we discussed how to install and configure Graphite to v">
<meta name="keywords" content="Monitoring,collectd">
<meta property="og:type" content="article">
<meta property="og:title" content="collectd">
<meta property="og:url" content="http://1byte.pro/monitoring/collectd.html">
<meta property="og:site_name" content="Just 1 Byte">
<meta property="og:description" content="IntroductionCollecting and visualizing data is an important way to make informed decisions about your servers and projects. In a previous guide, we discussed how to install and configure Graphite to v">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://assets.digitalocean.com/articles/collectd_statsd/server_stats.png">
<meta property="og:image" content="https://assets.digitalocean.com/articles/collectd_statsd/collectd_tree.png">
<meta property="og:updated_time" content="2018-08-28T09:41:44.161Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="collectd">
<meta name="twitter:description" content="IntroductionCollecting and visualizing data is an important way to make informed decisions about your servers and projects. In a previous guide, we discussed how to install and configure Graphite to v">
<meta name="twitter:image" content="https://assets.digitalocean.com/articles/collectd_statsd/server_stats.png">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">




    <link rel="shortcut icon" href="/img/favicon.ico">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-big-counter.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>collectd | Just 1 Byte</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>



    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b6bfb7348dc08eb"></script>




</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/head.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Gavin Wei</a></h1>
        </hgroup>

        
        <p class="header-subtitle">○|||||||○</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false">
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class="no-result">No results found <i class="fa fa-spinner fa-pulse"></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/about">九评博主</a></li>
                        
                            <li><a href="/archives">文章归档</a></li>
                        
                            <li><a href="/influxdb">InfluxDB</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa 简书" href="http://www.jianshu.com/users/7a890139a00e/latest_articles" title="简书"></a>
                            
                                <a class="fa Twitter" href="http://twitter.com/mrunamed" title="Twitter"></a>
                            
                                <a class="fa Quora" href="https://www.quora.com/profile/Gavin-Hill-5" title="Quora"></a>
                            
                                <a class="fa CSDN" href="mailto:none@canstop.me" title="CSDN"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ansible/">Ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/">Bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bigdata/">BigData</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/celery/">Celery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chromium/">Chromium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dind/">DIND</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/exception/">Exception</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flask/">Flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">Flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/freeipa/">FreeIPA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/">Gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hbase/">Hbase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/issue/">Issue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/">Jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jira/">Jira</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/">Kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monitor/">Monitor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monitoring/">Monitoring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/playbook/">Playbook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/prometheus/">Prometheus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/robustness/">Robustness</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlalchemy/">SQLAlchemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/scala/">Scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selenium/">Selenium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shame/">Shame</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlalhemy/">SqlAlhemy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/troubleshooting/">Troubleshooting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v/">V</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/collectd/">collectd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/container/">container</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fabfile/">fabfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fabric/">fabric</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grafana/">grafana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/graphite/">graphite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/image/">image</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jira/">jira</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lorote/">lorote</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/percona/">percona</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/seyren/">seyren</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ss5/">ss5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zookeeper/">zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工作笔记/">工作笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/性能优化/">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/日志切割/">日志切割</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/红芯浏览器/">红芯浏览器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/集群/">集群</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/雕虫小技/">雕虫小技</a></li></ul>
                    </div>
                </section>
                
                
                

                
                
                <section class="switch-part switch-part3">
                
                    <div id="js-aboutme">爱单车、爱Linux、学摄影 《Ansible权威指南》作者</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Gavin Wei</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/head.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Gavin Wei</a></h1>
            </hgroup>
            
            <p class="header-subtitle">○|||||||○</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/about">九评博主</a></li>
                
                    <li><a href="/archives">文章归档</a></li>
                
                    <li><a href="/influxdb">InfluxDB</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa 简书" target="_blank" href="http://www.jianshu.com/users/7a890139a00e/latest_articles" title="简书"></a>
                            
                                <a class="fa Twitter" target="_blank" href="http://twitter.com/mrunamed" title="Twitter"></a>
                            
                                <a class="fa Quora" target="_blank" href="https://www.quora.com/profile/Gavin-Hill-5" title="Quora"></a>
                            
                                <a class="fa CSDN" target="_blank" href="mailto:none@canstop.me" title="CSDN"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap"><article id="post-collectd" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/monitoring/collectd.html" class="article-date">
      <time datetime="2016-10-26T02:57:46.000Z" itemprop="datePublished">2016-10-26</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      collectd
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/monitoring/">Monitoring</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/monitoring/">Monitoring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/collectd/">collectd</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Collecting and visualizing data is an important way to make informed decisions about your servers and projects.</p>
<p>In a previous guide, we discussed how to install and configure Graphite to visualize data on our servers. However, we didn’t have a good way of collecting or even passing data into Graphite.</p>
<p>In this guide, we’ll discuss the installation and use of <code>collectd</code>, a system statistics gatherer that can collect and organize metrics about your server and running services.</p>
<p>We will show you how to install and configure collectd to pass data into Graphite to render. We will assume that you have Graphite up and running on an Ubuntu 14.04 server as we showed you in the last guide.<br><a id="more"></a></p>
<h2 id="Install-Collectd"><a href="#Install-Collectd" class="headerlink" title="Install Collectd"></a>Install Collectd</h2><p>The first thing we are going to do is install collectd. We can get this from the default repositories.</p>
<p>Refresh the local package index and then install by typing:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="builtin-name">get</span> update</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> install collectd collectd-utils</span><br></pre></td></tr></table></figure>
<p>This will install the daemon and a helper control interface. We still need to configure it so that it knows to pass the data it collects to Graphite.</p>
<h2 id="Configure-Collectd"><a href="#Configure-Collectd" class="headerlink" title="Configure Collectd"></a>Configure Collectd</h2><p>Begin by opening the collectd configuration file in your editor with root privileges:</p>
<p>sudo nano /etc/collectd/collectd.conf<br>The first thing that we should set is the hostname of the machine that we are on. Collectd can be used to send information to a remote Graphite server, but we are using this on the same machine for this guide. You can choose whatever name you’d like:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Hostname</span> <span class="string">"graph_host"</span></span><br></pre></td></tr></table></figure></p>
<p>If you have a real domain name configured, you can skip this and just leave toe <code>FQDNLookup</code> so that the server will use the DNS system to get the proper domain.</p>
<p>You may notice there is a parameter for “Interval”, which is the interval that collectd waits before querying data on the host. This is set by default to 10 seconds. If you followed along in the Graphite article, you will notice that this is the usual shortest interval for Graphite to track stats. These two values must match for data to be recorded reliably.</p>
<p>Next, we get right into the services that Collectd will gather information about. Collectd does this through the use of plugins. Most of the plugins are used to read information from the system, but plugins are also used to define where to send information. Graphite is one of these write plugins.</p>
<p>For this guide, we are going to ensure that the following plugins are enabled. You can comment out any other plugins, or you can work on configuring them correctly if you want to try them out on your host:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LoadPlugin apache</span><br><span class="line">LoadPlugin cpu</span><br><span class="line">LoadPlugin df</span><br><span class="line">LoadPlugin entropy</span><br><span class="line">LoadPlugin interface</span><br><span class="line">LoadPlugin load</span><br><span class="line">LoadPlugin memory</span><br><span class="line">LoadPlugin processes</span><br><span class="line">LoadPlugin rrdtool</span><br><span class="line">LoadPlugin users</span><br><span class="line">LoadPlugin write_graphite</span><br></pre></td></tr></table></figure></p>
<p>Some of these need configuration, and some of them will work fine out-of-the-box.</p>
<p>Continuing on down the file, we get to the configuration section of each plugin. Plugins are configured by defining a “block” for each configuration section. This is somewhat similar to how Apache compartmentalizes directives within blocks. We only will be taking a look at a few of these, since most of our plugins will work fine the way they are.</p>
<p>We enabled the Apache plugin because we have Apache installed to serve Graphite. We can configure the Apache plugin with a simple section that looks like this:<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Plugin apache&gt;</span></span><br><span class="line">    <span class="section">&lt;Instance "Graphite"&gt;</span></span><br><span class="line">        <span class="attribute">URL</span> <span class="string">"http://domain_name_or_IP/server-status?auto"</span></span><br><span class="line">        <span class="attribute">Server</span> <span class="string">"apache"</span></span><br><span class="line">    <span class="section">&lt;/Instance&gt;</span></span><br><span class="line"><span class="section">&lt;/Plugin&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>In a production environment, you may wish to keep the server stats protected behind an authentication layer. You can look at the commented code in this section of the file to see how that would work. For simplicity’s sake, we are going to demonstrate an open setup that is not authenticated.</p>
<p>We will be creating the <code>server-status</code> page for Apache that provides us with the details we need in a bit.</p>
<p>For the df plugin, which tells us how full our disks are, we can add a simple configuration that looks like this:<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;Plugin df&gt;</span></span><br><span class="line">    <span class="attribute">Device</span> <span class="string">"/dev/vda"</span></span><br><span class="line">    <span class="attribute">MountPoint</span> <span class="string">"/"</span></span><br><span class="line">    <span class="attribute">FSType</span> <span class="string">"ext3"</span></span><br><span class="line"><span class="section">&lt;/Plugin&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>You should point the device to the device name of the drive on your system. You can find this by typing the command in the terminal:<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">df</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Filesystem     <span class="number">1</span>K-blocks    Used Available Use% Mounted on</span><br><span class="line">/dev/vda        <span class="number">61796348</span> <span class="number">1766820</span>  <span class="number">56867416</span>   <span class="number">4</span>% /</span><br><span class="line">none                   <span class="number">4</span>       <span class="number">0</span>         <span class="number">4</span>   <span class="number">0</span>% /sys/fs/cgroup</span><br><span class="line">udev             <span class="number">2013364</span>      <span class="number">12</span>   <span class="number">2013352</span>   <span class="number">1</span>% /dev</span><br><span class="line">tmpfs             <span class="number">404836</span>     <span class="number">340</span>    <span class="number">404496</span>   <span class="number">1</span>% /run</span><br><span class="line">none                <span class="number">5120</span>       <span class="number">0</span>      <span class="number">5120</span>   <span class="number">0</span>% /run/lock</span><br><span class="line">none             <span class="number">2024168</span>       <span class="number">0</span>   <span class="number">2024168</span>   <span class="number">0</span>% /run/shm</span><br><span class="line">none              <span class="number">102400</span>       <span class="number">0</span>    <span class="number">102400</span>   <span class="number">0</span>% /run/user</span><br></pre></td></tr></table></figure>
<p>Choose the networking interface you wish to monitor:<br><figure class="highlight monkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;Plugin <span class="class"><span class="keyword">interface</span>&gt;</span></span><br><span class="line">    <span class="class"><span class="keyword">Interface</span> "<span class="title">eth0</span>"</span></span><br><span class="line">    IgnoreSelected <span class="literal">false</span></span><br><span class="line">&lt;/Plugin&gt;</span><br></pre></td></tr></table></figure></p>
<p>Finally, we come to the Graphite plugin. This will tell collectd how to connect to our Graphite instance. Make the section look something like this:<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;Plugin write_graphite&gt;</span><br><span class="line">    &lt;Node <span class="string">"graphing"</span>&gt;</span><br><span class="line">        Host <span class="string">"localhost"</span></span><br><span class="line">        Port <span class="string">"2003"</span></span><br><span class="line">        Protocol <span class="string">"tcp"</span></span><br><span class="line">        LogSendErrors <span class="literal">true</span></span><br><span class="line">        Prefix <span class="string">"collectd."</span></span><br><span class="line">        StoreRates <span class="literal">true</span></span><br><span class="line">        AlwaysAppendDS <span class="literal">false</span></span><br><span class="line">        EscapeCharacter <span class="string">"_"</span></span><br><span class="line">    &lt;<span class="string">/Node</span>&gt;</span><br><span class="line">&lt;<span class="string">/Plugin</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>This tells our daemon how to connect to Carbon in order to pass off its data. We specify that it should look to the local computer on port 2003, which Carbon uses to listen for TCP connections.</p>
<p>Next, we tell it to use that protocol to reliably hand off the data to Carbon. We tell it to log errors about the hand off and then set the prefix for the data. Since we end this value with a dot, all of the collectd stats for this host will be stored in a “collectd” directory.</p>
<p>The store rates determines whether stats will be converted to gauges before being passed. The append data source line would append the node name to our metrics if enabled. The escape character determines how certain values with dots in them are converted to avoid Carbon from splitting them into directories.</p>
<p>Save and close the file when you are finished.</p>
<h2 id="Configure-Apache-to-Report-Stats"><a href="#Configure-Apache-to-Report-Stats" class="headerlink" title="Configure Apache to Report Stats"></a>Configure Apache to Report Stats</h2><p>In our configuration file, we enabled Apache stats tracking. We still need to configure Apache to allow this though.</p>
<p>In the Apache virtual hosts file that we have enabled for Graphite, we can add a simple location block that will tell Apache to report stats.</p>
<p>Open the file in your text editor:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano <span class="regexp">/etc/</span>apache2<span class="regexp">/sites-available/</span>apache2-graphite.conf</span><br></pre></td></tr></table></figure></p>
<p>Below the “content” location block, we are going to add another block so that Apache will serve statistics at the /server-status page. Add the following section:<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Alias</span> /content/ /usr/share/graphite-web/static/</span><br><span class="line">    <span class="section">&lt;Location "/content/"&gt;</span></span><br><span class="line">        <span class="attribute"><span class="nomarkup">SetHandler</span></span> None</span><br><span class="line">    <span class="section">&lt;/Location&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="section">&lt;Location "/server-status"&gt;</span></span><br><span class="line">        <span class="attribute"><span class="nomarkup">SetHandler</span></span> server-status</span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Location&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">ErrorLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/graphite-web_error.log</span><br></pre></td></tr></table></figure></p>
<p>Save and close the file when you are finished.</p>
<p>Now, we can reload Apache to get access to the new statistics:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> service </span>apache2 reload</span><br></pre></td></tr></table></figure></p>
<p>We can check to make sure everything is working correctly by visiting the page in our web browser. We just need to go to our domain, followed by /server-status:<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//domain_name_or_IP/server-status</span></span><br></pre></td></tr></table></figure></p>
<p>You should see a page that looks something like this:</p>
<p><img src="https://assets.digitalocean.com/articles/collectd_statsd/server_stats.png" alt="server stats"></p>
<h2 id="Setting-the-Storage-Schema-and-Aggregation"><a href="#Setting-the-Storage-Schema-and-Aggregation" class="headerlink" title="Setting the Storage Schema and Aggregation"></a>Setting the Storage Schema and Aggregation</h2><p>Now that we have collectd configured to gather statistics about your services, we need to adjust Graphite to handle the data it receives correctly.</p>
<p>Let’s start by creating a storage schema definition. Open up the storage schema configuration file:<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano <span class="regexp">/etc/</span>carbon<span class="regexp">/storage-schemas.conf</span></span><br></pre></td></tr></table></figure></p>
<p>Inside, we need to add a definition that will dictate how long the information is kept, and how detailed the data should be at various levels.</p>
<p>We will tell Graphite to store collectd information at intervals of ten seconds for one day, at one minute for seven days, and intervals of ten minutes for one year.</p>
<p>This will give us a good balance between detailed information for recent activity and general trends over the long term. Collectd passes its metrics starting with the string <code>collectd</code>, so we will match that pattern.</p>
<p>The policy we described can be added by adding these lines. Remember, add these <strong>above</strong> the default policy, or else they will never be applied:<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[collectd]</span></span><br><span class="line"><span class="attr">pattern</span> = ^collectd.*</span><br><span class="line"><span class="attr">retentions</span> = <span class="number">10</span>s:<span class="number">1</span>d,<span class="number">1</span>m:<span class="number">7</span>d,<span class="number">10</span>m:<span class="number">1</span>y</span><br></pre></td></tr></table></figure></p>
<p>Save and close the file when you are finished.</p>
<p>Reload the Services<br>Now that collectd is configured and Graphite knows how to handle its data, we can reload the services.</p>
<p>First, restart the Carbon service. It is a good idea to use the “stop” and then “start” command with a few seconds in between instead of the “restart” command. This makes sure that the data is completely flushed prior to the restart:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> service </span>carbon-cache stop          ## wait a few seconds here</span><br><span class="line">sudo<span class="built_in"> service </span>carbon-cache start</span><br></pre></td></tr></table></figure></p>
<p>After the Carbon service is up and running again, we can do the same thing with collectd. The service may not be running yet, but this will ensure that it handles the data correctly:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo<span class="built_in"> service </span>collectd stop</span><br><span class="line">sudo<span class="built_in"> service </span>collectd start</span><br></pre></td></tr></table></figure></p>
<p>After this, you can visit your domain again, and you should see a new tree with your collectd information:</p>
<p><img src="https://assets.digitalocean.com/articles/collectd_statsd/collectd_tree.png" alt="collectd tree"></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Our collectd configuration is complete and our stats are already being recorded! Now, we have a daemon configured to track our server and services.</p>
<p>We can configure or write additional plugins for collectd as the need arises. Additional servers with collectd can also send data to our Graphite server. Collectd is mainly used for collecting statistics about common services and your machines as a whole.</p>
<p>In the next article, we’ll set up StatsD, a service that can cache data before flushing it to Graphite. This will allow us us to work around the problem of data loss when sending stats too quickly that we described in the previous article. It will also give us with an interface to track statistics within our own programs and projects.</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/monitoring/collectd.html">collectd</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Gavin Wei</a></p>
        <p><span>发布时间:</span>2016-10-26, 02:57:46</p>
        <p><span>最后更新:</span>2018-08-28, 09:41:44</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/monitoring/collectd.html" title="collectd">http://1byte.pro/monitoring/collectd.html</a>
            <span class="copy-path" data-clipboard-text="原文: http://1byte.pro/monitoring/collectd.html　　作者: Gavin Wei" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target="_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/devops/ansible-basics-playbook.html">
                    Ansible基础-Playbook入门
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/monitoring/seyren.html">
                    Deploy Seyren with Grafana on Ubuntu 14.04
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Install-Collectd"><span class="toc-number">2.</span> <span class="toc-text">Install Collectd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-Collectd"><span class="toc-number">3.</span> <span class="toc-text">Configure Collectd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Configure-Apache-to-Report-Stats"><span class="toc-number">4.</span> <span class="toc-text">Configure Apache to Report Stats</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setting-the-Storage-Schema-and-Aggregation"><span class="toc-number">5.</span> <span class="toc-text">Setting the Storage Schema and Aggregation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    

    
        <div class="addthis_sharing_toolbox"></div>
    
</div>







    
        <section id="comments">
    <style> aside.comment-bar { margin: auto 30px; }</style>
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function(){
            this.page.url = 'http://1byte.pro/monitoring/collectd.html';
            this.page.identifier = 'monitoring/collectd.html';
        };
        var loadComment = function(){
            var d = document, s = d.createElement('script');
            s.src = '//cancellara.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        }
    </script>
    
    <aside class="comment-bar">
        <a href="javascript:void(0);">
            <i class="fa fa-commenting-o animated infinite pulse"></i>
            <i class="fa fa-spinner fa-pulse"></i>
            <span class="count-comment"></span>
        </a>
    </aside>
    <script>
        var $commentBar = $("#comments aside.comment-bar");
        var load$hide = function(){
            $commentBar.find("a > i").toggle();
            loadComment();
            $commentBar.fadeOut(800);
        }
        $commentBar.click(function(){
            load$hide();
        })
        $commentBar.children("a").hover(function(){
            load$hide();
        })
        if (window.location.hash === "#comments") {
            load$hide();
        }
    </script>

</section>


    <script id="dsq-count-scr" src="//cancellara.disqus.com/count.js" async></script>
    <span class="disqus-comment-count" data-disqus-identifier="monitoring/collectd.html"></span>
    <span class="disqus-comment-count" data-disqus-url="http://1byte.pro/monitoring/collectd.html"></span>
    <script>
        $(".disqus-comment-count").hide();
        var $disqusCount = $(".disqus-comment-count");
        $disqusCount.bind("DOMNodeInserted", function(e) {
            $(".count-comment").text(
                $(this).text().replace(/[^0-9]/ig,"")
            )
            DISQUSWIDGETS.getCount({reset: true});
        })
    </script>


    




    <div class="scroll" id="post-nav-button">
        
            <a href="/devops/ansible-basics-playbook.html" title="上一篇: Ansible基础-Playbook入门">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/monitoring/seyren.html" title="下一篇: Deploy Seyren with Grafana on Ubuntu 14.04">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/python/ansible-sysctl.html">Ansible sysctl模块去重BUG</a></li><li class="post-list-item"><a class="post-list-link" href="/python/get-default-time-for-flask-sqlalchemy.html">Flask sqlalchemy 设置默认时间</a></li><li class="post-list-item"><a class="post-list-link" href="/python/celery-sqlalchemy-issue.html">Celery SQLAlchemy issue</a></li><li class="post-list-item"><a class="post-list-link" href="/python/flask-request.html">Flask request小结</a></li><li class="post-list-item"><a class="post-list-link" href="/python/celery-exc-type-error.html">Celery任务状态报错一例</a></li><li class="post-list-item"><a class="post-list-link" href="/bigdata/hbase-rowkey-rules.html">Hbase Rowkey设计规范参考</a></li><li class="post-list-item"><a class="post-list-link" href="/bigdata/zookeeper-election-rules.html">Zookeeper选举机制</a></li><li class="post-list-item"><a class="post-list-link" href="/devops/deploy-node-exporter-by-ansible.html">利用Ansible Playbook批量部署node_exporter</a></li><li class="post-list-item"><a class="post-list-link" href="/bigdata/foreach-forearchpartition.html">Spark性能优化之foreach与foreachPartition</a></li><li class="post-list-item"><a class="post-list-link" href="/devops/kafka-flume.html">Kafka与Flume区别</a></li><li class="post-list-item"><a class="post-list-link" href="/coding/scala-exception-handler.html">Scala异常获取一例</a></li><li class="post-list-item"><a class="post-list-link" href="/opinions/fake-chrome.html">红芯浏览器下载</a></li><li class="post-list-item"><a class="post-list-link" href="/issues/gitlab-trouble-shooting.html">Gitlab问题小结</a></li><li class="post-list-item"><a class="post-list-link" href="/python/chromium-on-centos-for-selenium.html">无GUI的CentOS上使用Selenium+Chrome</a></li><li class="post-list-item"><a class="post-list-link" href="/voice/v.html">V</a></li><li class="post-list-item"><a class="post-list-link" href="/bigdata/hadoop-banlancer.html">Hadoop集群中banlancer用法简介</a></li><li class="post-list-item"><a class="post-list-link" href="/issues/jira-over-https.html">Nginx开启HTTPS反向代理访问Jira失败</a></li><li class="post-list-item"><a class="post-list-link" href="/devops/install-freeipa-client.html">FreeIPA Client 端部署</a></li><li class="post-list-item"><a class="post-list-link" href="/devops/install-freeipa-server-on-centos.html">FreeIPA Server 端部署</a></li><li class="post-list-item"><a class="post-list-link" href="/devops/RobustnessOfShellScript.html">如何写出健壮的 Bash 脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/devops/ansible-basics-playbook.html">Ansible基础-Playbook入门</a></li><li class="post-list-item"><a class="post-list-link" href="/monitoring/collectd.html">collectd</a></li><li class="post-list-item"><a class="post-list-link" href="/monitoring/seyren.html">Deploy Seyren with Grafana on Ubuntu 14.04</a></li><li class="post-list-item"><a class="post-list-link" href="/monitoring/grafana.html">Deploy Graphite with Grafana on Ubuntu 14.04 (Part Ⅱ)</a></li><li class="post-list-item"><a class="post-list-link" href="/monitoring/graphite.html">Deploy Graphite with Grafana on Ubuntu 14.04(Part Ⅰ)</a></li><li class="post-list-item"><a class="post-list-link" href="/python/date-of-python.html">Python日期自然月加减实操</a></li><li class="post-list-item"><a class="post-list-link" href="/jenkins/jenkins.html">Jenkins Operation</a></li><li class="post-list-item"><a class="post-list-link" href="/docker/install-jira-manully.html">Jira Manully Install</a></li><li class="post-list-item"><a class="post-list-link" href="/docker/add-logrotate-to-percona-container.html">percona容器添加logrotate功能</a></li><li class="post-list-item"><a class="post-list-link" href="/docker/compile-image.html">Percona容器部署</a></li><li class="post-list-item"><a class="post-list-link" href="/docker/ss5.html">SS5 Installation</a></li><li class="post-list-item"><a class="post-list-link" href="/docker/docker-deployment.html">Docker deployment</a></li><li class="post-list-item"><a class="post-list-link" href="/docker/fabfile.html">vpnporxy 部署纪要</a></li></ul>




    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2020 Gavin Wei
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a>
            </div>
        </div>
        
            <div class="visit">
                
                
                
            </div>
        
    </div>
</footer>

    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-123125086-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>